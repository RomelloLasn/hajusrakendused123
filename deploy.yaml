import: 
  - recipe/laravel.php

config:
  repository: 'git@github.com:RomelloLasn/hajusrakendused123.git'
  keep_releases: 2
  shared_files:
    - .env
    - database/database.sqlite
  shared_dirs:
    - storage
    - bootstrap/cache
  writable_dirs:
    - bootstrap/cache
    - storage
    - storage/app
    - storage/app/public
    - storage/framework
    - storage/framework/cache
    - storage/framework/sessions
    - storage/framework/views
    - storage/logs

hosts:
  stage:
    hostname: 'tak22lasn.itmajakas.ee'
    http_user: virt118441
    remote_user: virt118441
    deploy_path: '~/domeenid/www.tak22lasn.itmajakas.ee/rakendused1'

tasks:
  opcache:clear:
    - run: killall php83-cgi || true
  
  build:assets:
    - run: 'cd {{release_path}} && npm ci && npm run build'
    - run: 'cd {{release_path}} && rm -rf node_modules'
    
  artisan:route:clear:
    - run: '{{bin/php}} {{release_path}}/artisan route:clear'
    
  fix:htaccess:
    - run: 'cp {{release_path}}/.htaccess.zone {{deploy_path}}/.htaccess'
    
  fix:permissions:
    - run: 'chmod -R 775 {{release_path}}/storage'
    - run: 'chmod -R 775 {{release_path}}/bootstrap/cache'
    - run: 'mkdir -p {{release_path}}/storage/framework/sessions'
    - run: 'mkdir -p {{release_path}}/storage/framework/views'
    - run: 'mkdir -p {{release_path}}/storage/framework/cache'
    - run: 'mkdir -p {{release_path}}/storage/logs'
    - run: 'chmod -R 775 {{release_path}}/storage/framework/sessions'
    - run: 'chmod -R 775 {{release_path}}/storage/framework/views'
    - run: 'chmod -R 775 {{release_path}}/storage/framework/cache'
    - run: 'chmod -R 775 {{release_path}}/storage/logs'
    
  setup:database:
    - run: 'mkdir -p {{deploy_path}}/shared/database'
    - run: 'touch {{deploy_path}}/shared/database/database.sqlite'
    - run: 'chmod 777 {{deploy_path}}/shared/database/database.sqlite'
    
  verify:stripe-keys:
    - run: "echo 'Verifying Stripe keys...'"
    - run: 'cd {{release_path}} && {{bin/php}} artisan tinker --execute="echo \"STRIPE KEY: \".env(\"STRIPE_KEY\").PHP_EOL.\"STRIPE SECRET: \".substr(env(\"STRIPE_SECRET\"), 0, 5).\"...\".PHP_EOL;"'

  deploy:
    - 'deploy:prepare'
    - 'deploy:vendors'
    - 'setup:database'
    - 'artisan:storage:link'
    - 'artisan:config:clear'
    - 'artisan:cache:clear'
    - 'artisan:route:clear'
    - 'artisan:view:clear'
    - 'artisan:migrate'
    - 'artisan:key:generate'
    - 'verify:stripe-keys'
    - 'fix:htaccess'
    - 'fix:permissions'
    - 'deploy:publish'
    
  deploy:writable:
    - run: 'chmod -R g+w {{release_path}}/storage'
    - run: 'chmod -R g+w {{release_path}}/bootstrap/cache'

after:
  deploy:failed: deploy:unlock

before:
  deploy:success: opcache:clear
  deploy:publish: deploy:writable